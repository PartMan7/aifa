<!DOCTYPE html>
<meta charset="utf8">

<html>
	<head>
		<title>AIFA - #3</title>
		<style>
			html, body {
				height: 100%;
				width: 100%;
				margin: 0;
				padding: 0;
			}

			#container {
				height: 500px;
				width: 300px;
				margin: 0;
				padding: 0;
				display: inline-block;
				float: left;
				border: 1px solid black;
			}

			#graph, #vehicles {
				width: 30%;
				height: 90%;
				display: inline-block;
				margin-top: 3%;
				float: left;
				text-align: center;
				font-size: 0.8em;
				overflow-x: scroll;
				overflow-y: scroll;
			}

			label {
				display: inline-block;
				font-size: 0.8em;
			}

			input[name=edge], input[name=ev], input.inputcell {
				width: 20px;
				display: inline-block;
				font-size: 0.8em;
			}

			input.nums {
				width: 25px;
				display: inline-block;
				font-size: 0.8em;
			}

			input#nodenum, input#evnum {
				width: 15px;
			}

			fieldset {
				width: 60%;
				margin: auto;
			}

			div.inline {
				display: inline-block;
				margin-left: margin-right: 5px;
			}
		</style>

		<script>
			const debug = true;

			const {sin, cos, PI} = Math, radius = 100, colours = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'];

			let info = {
				nodes: [],
				edges: [],
				EVs: {},
				nodepos: {}
			}

			if (debug) {
				info.nodes = Array.from({length: 5}).map((n, i) => `V${i + 1}`);
				info.edges = [
					{ from: 'V1', to: 'V2', weight: 8 },
					{ from: 'V1', to: 'V4', weight: 4 },
					{ from: 'V1', to: 'V5', weight: 10 },
					{ from: 'V2', to: 'V3', weight: 4 },
					{ from: 'V3', to: 'V4', weight: 7 },
					{ from: 'V3', to: 'V7', weight: 6 },
					{ from: 'V4', to: 'V5', weight: 8 },
					{ from: 'V4', to: 'V7', weight: 6 },
					{ from: 'V5', to: 'V6', weight: 5 },
					{ from: 'V6', to: 'V7', weight: 1 },
					{ from: 'V6', to: 'V8', weight: 2 },
					{ from: 'V7', to: 'V8', weight: 5 }
				]
				info.EVs = {
					"P1": {
						"source": "V1",
						"destination": "V8",
						"init_battery": 5,
						"charging": 2,
						"discharging": 3,
						"max": 100,
						"speed": 12
					},
					"P2": {
						"source": "V2",
						"destination": "V8",
						"init_battery": 20,
						"charging": 10,
						"discharging": 11,
						"max": 200,
						"speed": 20
					},
					"P3": {
						"source": "V3",
						"destination": "V6",
						"init_battery": 4,
						"charging": 1,
						"discharging": 2,
						"max": 120,
						"speed": 15
					},
					"P4": {
						"source": "V4",
						"destination": "V1",
						"init_battery": 4,
						"charging": 2,
						"discharging": 3,
						"max": 100,
						"speed": 12
					}
				}
			}

			let ctx;

			window.onload = () => {
				ctx = document.getElementById('canvas').getContext('2d');
				ctx.lineWidth = 1;
			}

			function setnodes () {
				let txt, num = debug ? 8 : parseInt(txt = document.getElementById('nodenum').value);
				if (isNaN(num) || num < 1) return alert(`Invalid number of nodes (${txt})`);
				info.nodes = [];
				for (let i = 0; i < num; i++) info.nodes.push(`V${i + 1}`);
				let allEdges = [];
				for (let i = 1; i <= num; i++) for (let j = i + 1; j <= num; j++) allEdges.push([i, j]);
				document.getElementById('edges').innerHTML = allEdges.map(bw => `<label for="V${bw[0]}|V${bw[1]}">V${bw[0]}-V${bw[1]}</label>: <input type="text" name="edge" id="V${bw[0]}|V${bw[1]}" value="-"	placeholder="Length" required />`).join('<br />');
				document.getElementById('edgestitle').hidden = false;
				document.getElementById('graphbuttons').hidden = false;
				document.getElementById('vehicles').style.visibility = 'hidden';
				document.getElementById('vehtitle').hidden = true;
				document.getElementById('evbuttons').hidden = true;
			}

			function draw (info, vehs) {
				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
				const delta = 2 * PI / info.nodes.length;

				info.nodes.forEach((node, i) => info.nodepos[node] = [150 + radius * cos(i * delta), 150 - radius * sin(i * delta)]);

				info.edges.forEach(edge => {
					ctx.lineWidth = 1;
					ctx.beginPath();
					ctx.moveTo(...info.nodepos[edge.from]);
					ctx.lineTo(...info.nodepos[edge.to]);
					ctx.stroke();
				});

				info.edges.forEach(edge => {
					let midpoint = [(info.nodepos[edge.from][0] + info.nodepos[edge.to][0]) / 2, (info.nodepos[edge.from][1] + info.nodepos[edge.to][1]) / 2];
					ctx.fillStyle = 'white';
					ctx.beginPath();
					ctx.arc(midpoint[0], midpoint[1], 10, 0, 2 * PI, false);
					ctx.fill();
					ctx.fillStyle = 'black';
					ctx.font = '10px Arial';
					ctx.fillText(edge.weight, midpoint[0] - (edge.weight <= 9 ? 3 : 6), midpoint[1] + 4);
				});

				Object.keys(info.nodepos).forEach(node => {
					ctx.font = '20px Arial';
					ctx.lineWidth = 1;
					const coord = info.nodepos[node];
					ctx.beginPath();
					ctx.arc(coord[0], coord[1], 20, 0, 2 * PI, false);
					ctx.fill();
					ctx.beginPath();
					ctx.fillStyle = 'white';
					ctx.arc(coord[0], coord[1], 18, 0, 2 * PI, false);
					ctx.fill();
					ctx.fillStyle = 'black';
					ctx.fillText(node, coord[0] - 12, coord[1] + 7);
				});
			}

			function generate () {
				if (!debug) {
					let inputs = document.getElementsByName('edge');
					let data = {
						nodes: info.nodes.map(node => ({id: node}))
					}
					info.edges = [];

					for (let i = 0; i < inputs.length; i++) {
						const edge = inputs[i];
						if (!edge.value) return;
						if (edge.value === '-') continue;
						const val = parseInt(edge.value);
						if (isNaN(val)) return alert(`[${edge.id.split('|').join('-')}] ${edge.value} is not a valid number.`);
						let coords = edge.id.split('|');
						info.edges.push({ from: coords[0], to: coords[1], weight: String(val) });
					}
					data.edges = info.edges;
					info.EVs = {};
				}

				document.getElementById('vehicles').style.visibility = 'visible';
				draw(info, []);
			}

			function setevs () {
				let txt, num = parseInt(txt = document.getElementById('evnum').value);
				if (isNaN(num) || num < 1) return alert(`Invalid number of vehicles (${txt})`);
				info.EVs = {};
				for (let i = 0; i < num; i++) info.EVs[`P${i + 1}`] = {};
				document.getElementById('evs').innerHTML = Object.keys(info.EVs).map(ev => `<fieldset><legend>${ev}</legend><div class="inline"><label for="${ev}source">Source</label>: <input type="text" list="${ev}sourcelist" id="${ev}source" class="inputcell" required /><datalist id="${ev}sourcelist">${info.nodes.map(node => `<option value="${node}" />`).join('')}</datalist></div><div class="inline"><label for="${ev}dest">Target</label>: <input type="text" list="${ev}destlist" id="${ev}dest" class="inputcell" required /><datalist id="${ev}destlist">${info.nodes.map(node => `<option value="${node}" />`).join('')}</datalist></div><br /><div class="inline"><label for="${ev}max">Battery Capacity</label>: <input type="text" id="${ev}max" class="nums" required /></div><div class="inline"><label for="${ev}init">Current Battery</label>: <input type="text" id="${ev}init" class="nums" required /></div><br /><div class="inline"><label for="${ev}charge">Charging Rate</label>: <input type="text" id="${ev}charge" class="nums" required /></div><div class="inline"><label for="${ev}discharge">Discharging Rate</label>: <input type="text" id="${ev}discharge" class="nums" required /></div><br /><div class="inline"><label for="${ev}init">Current Battery</label>: <input type="text" id="${ev}init" class="nums" required /></div></fieldset>`).join('<br />');
				document.getElementById('vehtitle').hidden = false;
				document.getElementById('evbuttons').hidden = false;
			}

			function run () {
				let inputs = document.getElementsByName('edge');

				// stuff

				for (let i = 0; i < 12; i++) {
					const edge = inputs[i];
					if (!edge.value) return;
					const val = parseInt(edge.value);
					if (isNaN(val)) return alert(`[${edge.id.split('|').join('-')}] ${edge.value} is not a valid number.`);
					let coords = edge.id.split('|');
					data.edges.push({ from: coords[0], to: coords[1], weight: val });
				}

				const graph = {};
				data.nodes.forEach(node => graph[node.id] = {});
				data.edges.forEach(edge => {
					graph[edge.from][edge.to] = edge.weight;
					graph[edge.to][edge.from] = edge.weight;
				});

				return console.log(JSON.stringify(graph));
			}
		</script>

	</head>
	<body>
		<div id="container"><canvas id="canvas" width="500px" height="300px">Unsupported browser, please update</canvas></div>
		<div id="graph">
			<h2>Nodes</h2>
			How many nodes does the graph have? <input type="text" id="nodenum" value="5" placeholder="#" required />&nbsp;&nbsp;<button onclick="setnodes()">Set</button>
			<br />
			<h2 id="edgestitle" hidden>Edges</h2>
			<div id="edges"></div>
			<br />
			<span id="graphbuttons" hidden><button name="Generate!" onclick="generate()">Generate map!</button></span>
		</div>
		<div id="vehicles" style="visibility: hidden;">
			<h2>Vehicles</h2>
			How many vehicles does the simulation have? <input type="text" id="evnum" value="3" placeholder="#" required />&nbsp;&nbsp;<button onclick="setevs()">Set</button>
			<br />
			<h2 id="vehtitle" /*hidden*/>Details</h2>
			<div id="evs">
			</div>
			<br />
			<span id="evbuttons" hidden><button name="run" onclick="run()">Run simulation!</button></span>
		</div>
	</body>
</html>
